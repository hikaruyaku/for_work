# 実験計画法(Design of Experiments)についてのまとめ

## 実験計画法をやる意義とこの資料で説明する範囲

### 背景  

実験計画法とは、タグチメソッド等で知られている直交表などを用いて実験を行う手法である。これにより、以下の内容を把握することを目的としている。

1. 目的変数 y に影響を与える因子を特定する
   - sn比などから目標にバラツキを大きく与える因子を特定する。
2. 最適な説明変数を算出する(応答曲面法｜Response Surface Methodology)
   - 目的変数yが狙った方針を得る為の説明変数Xを探索する

これまで、技術・CS部にいて、1.は多く見てきたが、2. についてはあまり見てこなかったので、1. , 2. について説明を行う。

### ゴールと説明範囲

この資料を纏め、ゴールとしては

> **「実験計画法について、自力で直交表が組めて、**
>
> ​	**目的変数 y に対して、説明変数 X が与えるバラツキの影響を説明でき(SN比)、**
>
> ​	**目標に対して最適な X を探索(RSM)できるようにする」**

を目標にしたい。

目的である、バラツキの影響やRSMが出来る様にするためにはまずは自力で直交表を作成出来る様になる必要がある。次にその直交表にて実施した実験内容から説明変数が与える影響を確認し、最終的には目標に対して最適な X を探索する。  



## 直交表の作成方法

### 目的

ある実験について、目標を得る為の最適な条件を探索する際にどのようにすればいいだろうか？例えば、5種類の実験条件に対して全てに10通りの設定値候補があると、全ての組み合わせは 100,000 通りとなる。この全ての実験条件を行うのは非現実的である。そのため、直交表を用いて実験条件を大幅に削減することが必要になる[^1]。

### 直交表とは

直交表は wikipedia[^2]によると、以下の通りの記載がある。

> 直交表（ちょっこうひょう）とは、どの2列をとっても、その[水準](https://ja.wikipedia.org/wiki/実験計画法)のすべての組み合わせが同数回現れる[配列](https://ja.wikipedia.org/wiki/配列)のことである。これを「その2列はバランスしている」あるいは「[直交](https://ja.wikipedia.org/wiki/直交)している」と呼ぶ。この性質を使って、[実験計画法](https://ja.wikipedia.org/wiki/実験計画法)において[因子](https://ja.wikipedia.org/wiki/因子分析)と水準の割り付け表に用いられる。

直交表については、以下の表記となる。

![image-20200505103056550](https://github.com/hikaruyaku/for_work/blob/master/DoE/image-20200505103056550.png)

これで、全ての水準組み合わせについて実験するのではなく、そのうちの一部の実験だけを行う方法である直交実験[^3]を行うことで、目的にも記載した実験回数の削減が達成できる。

直交表は以下の種類がある。

- 2水準系
  - L~4~(2^3^),  L~8~(2^7^), L~16~(2^15^), L~32~(2^31^), L~64~(2^63^)
- 3水準系
  - L~9~(3^4^), L~27~(3^13^)
- 混合系
  - L~18~(2^1^ ×3^7^), L~36~(2^11^×3^12^)

### 直交表の選び方

直交表については、以下の注意点・ポイントがある。

- 割付に関係なく、3因子以上の交互作用効果は測定できない。
- 2水準系の場合には、「因子数＋交互作用数」以上の列を持つ直交表を選ぶ。
- 3水準系の場合には、「因子数＋2×交互作用数」以上の列を持つ直交表を選ぶ。



### 直交表への割付の仕方|線点図[^3]

直交表へ因子を割付を行うが、**線点図**を用いる。これは、因子や交互作用の関係が複雑となり、成分記号による方法では割付が困難になる為である。線点図については、次のルールで作られる

- 点は一つの列を表す。
- 線は2水準系の場合にはどれか1つの列を表し、3水準系の場合にはどれか2つの列を表す。
- 点と点を結ぶ線は、それら2つの点が表す列の間の交互作用が現れる列を表している。

なお、線点図を使った割付の手順は、次のようになります。

1. 実験に取り上げた因子を添で、交互作用を線で表し、因子と交互作用の関係を図で表現する。この図を「必要な線点図」という。
2. 必要な線点図をあらかじめ用意されている線点図に埋め込む。これによって、因子と交互作用のわりつけがきまる。
3. 交互作用と関連のない因子は、あいている点あるいは線の列に割り付ける。
4. 最後にあまった点、あるいは線の列には誤差を割り付ける。



<font color="red"> 線点図を集めて貼り付ける　</font>



### D最適基準[^1]

実験条件を探索し、直交表(というより良好なモデルを探索する為に適した実験条件)を算出する為の方法論になる。これまで述べてきた直交表は**共線性について不明な場合に用いられることが多い**と理解している。一方で、共線性が低く、お互いの説明変数が独立であるのであればD最適基準等を行う方が適している。

モデルの良し悪しを評価する為には説明変数と目的変数が無いと評価できないが、最小二乗(OLS| Ordinary Least Squares)法による線形重回帰分析で良好なモデルを構築するための必要条件であれば、データセットのない状況でも検討が出来る。
線形重回帰係数ベクトル**$b$**は
$$
b = (X^TX)^{-1}X^Ty
$$
回帰係数を得る為には逆行列$(X^TX)^{-1}$を計算できる必要がある。その為、$X^TX$の行列式($det(X^TX)$)が大きくなるような実験条件を選ぶ。こうすることで実験結果が無くても、実験条件のデータセットのみから候補を選ぶことが出来る。

また、D最適基準の他にも種類がある。以下の表にまとめる。

| 方法         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| A 最適基準   | $X^TX$ の逆行列の対角成分の和を最小化                        |
| D 最適基準   | $X^TX$ の行列式の値を最大化                                  |
| E 最適基準   | $X^TX$ の固有値の最小値を最大化                              |
| I 最適基準   | $X^T(X^TX/m)^{-1}X$ の対角成分の平均値を最小化<br />$m$ : サンプル数 |
| minimax 基準 | $X^TX$ の対角成分の最大値を最小化                            |

なお、D最適基準での直交表作成については Google Colab にて簡単に作成出来る様にした。[こちらのページ](https://github.com/hikaruyaku/for_work/blob/master/DoE/DoE(D%E6%9C%80%E9%81%A9%E5%9F%BA%E6%BA%96).ipynb) から試してください。


## バラツキの影響｜SN比[^3]

### タグチメソッド

田口玄一氏によって体系化された製品の開発及び設計のための方法論である。その中でもパラメータ設計は、直交表を利用して実験条件を定めたり、分散分析表を作成して因子の効果の有無を判定したりすることから実験計画法の応用手法と言える。  

製品設計では、どのような環境条件や使用条件においてもその製品が安定して機能するように制御因子の水準を決める必要がある。このような設計手法を**ロバストな設計**という。このロバストな設計の為には、制御因子と誤差因子を決定する必要がある(具体的には、**パラメータ設計**といい、誤差因子の影響が小さくなるように制御因子の水準を決定する)。

> 制御因子：水準を意図的に設定でき、最適水準を決めることに意味のある因子
>
> 誤差因子：環境条件や使用条件等の製品の使用時に水準が変化してしまう制御できない因子

### タグチメソッドのデータ収集形式

タグチメソッドのパラメータ設計では、次のような方法でデータの収集が行われる。

1. 制御因子と誤差因子をそれぞれいくつか取り上げる。
2. 制御因子の個数や水準数に対応して実験計画(**内側配置**)を選ぶ。
   - 内側配置にはL~18~(2^1^×3^7^)などの混合系直交表による直交実験がよく使われる。
3. 誤差因子の個数や水準数に対応して実験計画(**外側配置**)を選ぶ。
   - 外側配置には直交実験の他に、一元配置法や二元配置法なども使われる。
4. 内側配置によって定まる制御因子の水準組み合わせと外側配置によって定まる誤差因子の水準組み合わせについて、それらの間のすべての組み合わせについて実験を行う。したがって、内側配置=$n$通り、外側配置=$r$通りであれば、実験回数は$nr$となる(**直積配置**)。
5. 実験を行う順序としては、まず内側配置の$n$通りの水準組み合わせでの実験順序をランダムに定め、次にその水準組み合わせのそれぞれに対して外側配置の$r$通りの水準組み合わせでの実験をランダムな順序で行う分割法等が利用される。

例えば、内側配置にL~8~(2^7^)、外側配置にL~4~(2^3^)を用いた場合は以下の様になる。

![image-20200505134949385](https://github.com/hikaruyaku/for_work/blob/master/DoE/image-20200505134949385.png)

パラメータ設計では、各水準組み合わせでのデータ Y~i1~, Y~i2~, Y~i3~, Y~i4~のばらつきが小さくなるような制御因子の最適水準を求める。そのために、これらのデータから**SN(Signal to Noise ratio)比**と呼ばれる解析用特性値を計算します。

### タグチメソッドにおけるデータ解析の考え方

タグチメソッドでは、特性値を次の様に分類している。なお、これらは一定の目標値を持つ特性で、**静特性**とも呼ばれる。

- 望小特性：非負の値をとり、その値が小さいほど良いという品質特性(目標値=0)
- 望大特性：非負の値をとり、その値が大きいほど良いという品質特性(目標値=無限大)
- 望目特性：特性の有限値を目標値とする品質特性

#### SN比の計算

内側配置によって定まる$i$番目の水準組み合わせにおいて、$r$個のデータY$_i$~1~, Y$_i$~2~, ・・・, Y$_ir$が得られているとする。また、これらのデータは互いに独立に母平均$\mu$, 母分散$\sigma ^2$の分布に従うとする。

SN比は
$$
\mu = \frac{\mu^2}{\sigma^2}
$$
この分子$\mu ^2$は感度と呼ばれることもある。

いま、$\mu^2$、$\sigma ^2$が未知であるため、SN比はデータY$_i$~1~, Y$_i$~2~, ・・・, Y$_ir$から推定する。いま標本平均を、
$$
\bar{Y_i} = \frac{1}{r}{\sum_{j=1}^r}Y_{ij}
$$
とすると、$\sigma^2$の不偏推定量は不偏分散
$$
\sigma^2　= V_e = \frac{1}{r-1}\sum_{j=1}^r(Y_{ij}-\bar{Y_i})^2
$$
であり、感度$\mu^2$の不偏推定量は
$$
\mu^2 = \bar{Y_i^2} - \frac{V_e}{r}
$$
で与えられる。よって、SN比の推定値は
$$
\hat{\eta} = \frac{\mu^2}{\sigma^2} = \frac{\bar{Y_i^2}-V_e/r}{V_e}
$$
となる。ただし、解析の際には、常用対数を取り、かつ10 倍した、
$$
\hat{\eta} = 10log_{10}\frac{\bar{Y_i^2}-V_e/r}{V_e}
$$
が用いられる。

1. 望小特性

   平均$\mu$と分散$\sigma^2$の両方とも小さくすれば良いことから、SN比は
   $$
   \eta = \mu^2 + \sigma^2
   $$
   となる。$\mu^2 + \sigma^2$の不偏推定量が、$\frac{1}{r}\sum_{j=1}^rY_{ij}^2$であるので、SN比の推定値は、
   $$
   \hat{\eta} = -10log_{10}\frac{1}{r}\sum_{j=1}^rY_{ij}^2
   $$
   となる。マイナスをついているのは、望目特性のSN比に併せて「値がおおきいほど良い」とするため。

2. 望大特性

   $1/Y_{ij}$は望小特性についてのデータとなるため、SN比の推定値は
   $$
   \hat{\eta} = -10log_{10}\frac{1}{r}\sum_{j=1}^r \frac{1}{Y_{ij}^2}
   $$
   となる。

## 応答曲面法(RSM)

### 応答局面法とは
応答局面法とは、応答 $y$ と量的な因子$x_1, x_2, …, x_p$ の関係について、実験計画に従ってデータを収集し、それを解析することで応答と因子の関係を探索する一連の方法である[^4]。応答と因子を表現する$\mu(x_1,x_2, ...x_p)$ について、理論的には $x$ に関してのどのような関数型をも考えることが出来る。しかし、実験を行う場合には局所的な領域について興味があるので、
	一次式
	$$
	\mu(x_1, x_2,..., x_p) = \beta_o + \beta_1x_1 + \beta_2x_2 + \beta_px_p = \sum_{i=1}^p\beta_ix_i
	$$ 
	または、二次式
	$$
	\mu((x_1, x_2,..., x_p) = \beta_o + \beta_1x_1 + \beta_2x_2 + \beta_px_p  \\  + \beta_{12}x_1x_2 + \beta_{13}x_1x_3 + ... +\beta{p-1}x_{p-1}x_p \\ + \beta_{11}x_1^2 + \beta_{22}x_2^2 + ... + \beta_{pp}x_p^2
	$$
で表現できるものとして解析を行う。

曲面応答法は①局面応答計画と②応答曲面解析から構成される。

|名称  |内容  |
|--|--|
|応答曲面計画  |具体的にどのような水準で実験を行うかの計画  |
|応答曲面解析  |既に収集されている実験データを基に最適条件を探索したり、次の実験領域を選んだりする  |

### データの扱い方①｜データの種類・質
データはまず収集されたデータの質、及び変数の標準化が必要になる。
データの質とは大きく二つあり、それを以下の表にてまとめる。

|データの種類  |内容  |使用シーン|
|--|--|--|
|観察データ  |データを現場の作業記録等から得る  |応答と因子間の因果関係が保証されない  |
|実験データ  |計画した実験により収集  |因果関係が反映された形でデータが収集される  |

### データの扱い方②｜標準化
データは標準化することで各データ間の大小の関係が解析に反映されない様に工夫する。標準化とは以下の内容である。
$$
[標準化] = \frac{[データ] - [平均値]}{[標準偏差]} = \frac{x-\mu}{\sigma}
$$

### 最急上昇法による逐次実験
因子に対してどの水準、もしくは値が最適になるかを確認する方法として、しらみ潰しに条件を探索することが考えられるがコストや時間が大いにかかってします。そこで、逐次的に実験を行うことで、応答の最適化を図る。応答と因子の関係は興味のある領域全体では複雑であるが、局所的な領域では1次モデル等の単純なモデルで表現できることから、**興味のある領域全体で考えるのではなく、局所的に実験領域を設定し、1次モデル等の単純なモデルに基づいて、一部実施要因計画等で効率よく実験を構成する。そして、その結果を解析し、応答をより大きく(小さく)する領域を逐次的に探索する。**
方法としては以下の様になる。
1. その領域において実験を行い、応答曲面を推定する。
2. どの方向に次の実験領域を移動したらよいのかを推定する  
3. 移動距離を決定する。
4. 1に戻り、実験を再度行う。もしモデルの当てはまりが悪い場合には、実験を追加する等して異なるモデルのあてはめを行う。
5. 応答曲面の形状を分析し、応答を最大化(最小化)する条件に到達したかどうかを判断する。

2の移動方向については、等高線表示等を行うことで次の方向を可視化することが出来る。ただし、注意点として、  
- 等高線表示に取り上げていない変数の水準があるので、注意する。
- 交互作用がある場合には等高線の形状が変わることを念頭に置く。
等がある。


DoEにより得られた候補と実験の結果得られた目的変数のデータセットを用いて、説明変数と目的変数との間で回帰モデルを構築し、新たな候補を探索する手法。この手法にはGriewank関数を用いる。
$$
y = 0.5 \times (1-\frac{1}{4000}\sum_{i=1}^nx_i^2 + \prod_{i=1}^ncos(\frac{x_i}{\sqrt{i}}))
$$


このGriewank関数の特徴として、

- 非線形関数を変形したもの
- 非常に多くの局所解を持つ

以上の様な性質を持つため、数値実験のベンチマークに汎用される関数の一つとなっている。


# 参考文献

[^1]: 化学工学会 会誌 Vol.84(2020)
[^2]: [Wikipedia記事]([https://ja.wikipedia.org/wiki/%E7%9B%B4%E4%BA%A4%E8%A1%A8](https://ja.wikipedia.org/wiki/直交表))
[^3]: 「Excelで学ぶ理論と技術 実験計画入門」星野 直人・関 庸一 著
[^4]: 「実験計画法ー方法論ー」山田 秀 著
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE5NzkyNzU5NjYsMTUxNzk4NTA3MCwtMT
AxMTQzMTE0N119
-->